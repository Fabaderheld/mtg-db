<!DOCTYPE html>
<html>

<head>
    <title>Lorcana Card Recognition - Camera Import</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <h1>Lorcana Card Recognition - Camera Import</h1>

        <div class="video-container">
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="processed-frame" alt="Processed Frame">
        </div>

        <div class="card-info">
            <h2>Card Information</h2>
            <div id="info-content">No card detected</div>
        </div>

        <div class="debug-info">
            <h2>Debug Information</h2>
            <div id="debug-content">No debug info</div>
        </div>

        <div class="controls" style="font-size:1.2em;">
            <label>Min Area:
                <input type="range" id="min-area" min="100" max="50000" value="10000" step="100">
                <span id="min-area-value">10000</span>
            </label><br>
            <label>Canny Low:
                <input type="range" id="canny-low" min="0" max="255" value="50" step="1">
                <span id="canny-low-value">30</span>
            </label><br>
            <label>Canny High:
                <input type="range" id="canny-high" min="0" max="255" value="150" step="1">
                <span id="canny-high-value">100</span>
            </label><br>
            <label>Epsilon:
                <input type="range" id="epsilon" min="0.01" max="0.3" value="0.15" step="0.01">
                <span id="epsilon-value">0.15</span>
            </label>
        </div>
    </div>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('canvas');
        const processedFrame = document.getElementById('processed-frame');
        const ctx = canvas.getContext('2d');

        ['min-area', 'canny-low', 'canny-high', 'epsilon'].forEach(id => {
            const slider = document.getElementById(id);
            const label = document.getElementById(id + '-value');
            slider.addEventListener('input', () => {
                label.textContent = slider.value;
            });
        });

        let lastCardInfo = null;
        let lastDebugInfo = null;

        function updateInfo(data) {
            if (data.card_info && data.card_info.name) {
                lastCardInfo = data.card_info;
                // ... build and display card info HTML ...
            }
            if (data.debug_info) {
                lastDebugInfo = data.debug_info;
                // ... build and display debug info HTML ...
            }
            // If no card detected, do not overwrite the display
            if (!data.card_info || !data.card_info.name) {
                // Optionally, show a subtle "No card detected" message somewhere else
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    setInterval(sendFrameToServer, 500);
                });
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Unable to access camera. Please check permissions and ensure HTTPS.");
            }
        }

        async function sendFrameToServer() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            // Get parameter values from the inputs
            const minArea = parseInt(document.getElementById('min-area').value, 10);
            const cannyLow = parseInt(document.getElementById('canny-low').value, 10);
            const cannyHigh = parseInt(document.getElementById('canny-high').value, 10);
            const epsilon = parseFloat(document.getElementById('epsilon').value);

            const response = await fetch('{{ url_for("lorcana.process_frame_route") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    image: imageData,
                    min_area: minArea,
                    canny_low: cannyLow,
                    canny_high: cannyHigh,
                    epsilon: epsilon
                })
            });

            const data = await response.json();
            document.getElementById('processed-frame').src = data.processed_image;

            // Show card info if available
            let cardHtml = '';
            if (data.card_info && data.card_info.name) {
                cardHtml = `
        <div>
            <strong>Name:</strong> ${data.card_info.name}<br>
            <strong>Set:</strong> ${data.card_info.set || ''}<br>
            <strong>Type:</strong> ${data.card_info.type || ''}<br>
            <strong>Ink:</strong> ${data.card_info.ink || ''}<br>
            <strong>Cost:</strong> ${data.card_info.cost || ''}<br>
            <strong>Strength:</strong> ${data.card_info.strength || ''}<br>
            <strong>Willpower:</strong> ${data.card_info.willpower || ''}<br>
            <strong>Rarity:</strong> ${data.card_info.rarity || ''}<br>
            <strong>Text:</strong> ${data.card_info.text || ''}<br>
        </div>
    `;
            } else {
                cardHtml = 'No card detected';
            }
            document.getElementById('info-content').innerHTML = cardHtml;

            // (Optional) Show extracted text or debug info
            if (data.extracted_text) {
                document.getElementById('debug-content').innerText = data.extracted_text;
            }
        }

        startCamera();
    </script>
</body>

</html>